# 项目实现导读

本文档帮助快速理解“项目实现”目录下的主要组件与运行方式。

## 目录结构与角色
- Graph.h：最小图结构与常量 INF_DIST。提供 `Graph`（邻接表）与 `Edge` 定义。
- Dijkstra.h：标准 Dijkstra 算法（小根堆），用于对照与校验。
- BMSSP.h：BMSSP 算法（Algorithm 1~3）与分块队列 BlockQueue（支持 Lemma 3.3 适配与基线实现）。
  - FindPivots（算法1）：从候选集合 F 中挑选 pivots；必要时触发“大工作量回退”。
  - BaseCase（算法2）：以单个 k 为源的限界 Dijkstra，确定 B' 与集合 X。
  - BMSSPAlgo（算法3）：递归推进，使用分块队列管理 [B', Bsep) 与 [Bsep, B) 两段标签的推进与重入。
- compare_main.cpp：对比主程序。生成随机定出度图，运行 BMSSP 与 Dijkstra，输出时间与校验信息。
- opt_landings/BlockQueueLemma33.h：论文 Lemma 3.3 的工程化分块队列实现（D0/D1 两段 + UB 树）。
- benchmark.sh：批量构建、运行、采集 CSV 的脚本。
- plot_bench.py：读取 CSV 并绘图输出（比值曲线、时间曲线、操作计数曲线）。

## 关键数据结构（BlockQueue）
- D0：仅批量前置 batchPrepend 进入的块序列，语义为“比现有任何值都小的区间”。
- D1：仅 insert 进入的块序列；通过 UB 树（std::map<UB, blockIt>）按块上界有序索引。
- 操作：
  - insert(key,val)：写入 D1 中 UB>=val 的首个块，超长则按中位数拆分；惰性去重由 key2val_ 保证。
  - batchPrepend(L)：对 L 逐键取最小值，排序后切成不超过 m_ 的块，前插入 D0。
  - pull()：先从 D0，后从 D1 的最小 UB 块提取，至多 m_ 个；返回提取的 keys 与当前分隔 sep。

## BMSSP 递归流程（Algorithm 3 视角）
- 参数：层数 ell、区间上界 B、入口集合 F。
- 步骤：
  1) FindPivots 选取 P、访问集 A；若 |A| 过大且 P==F，则回退 BaseCase。
  2) 用 M=2^(ell-1)*Tau 初始化分块队列；将 pivots 的标签入队。
  3) 循环：pull -> 递归 run(ell-1,Bsep,Fnext) -> 写回更优距离 -> 边松弛（区间分派）-> 将 [B',Bsep) 内的 pivots 批量前置；若完成数超阈值则提前结束。
  4) 汇总 Uacc 与 A，按 B0' 选出 X 与 Xdist，返回 {B0', X, Xdist}。

## compare_main 的参数与输出
- 运行参数：
  - argv[1]=n（顶点数），argv[2]=固定出度，argv[3]=随机种子（可选，默认 42）。
  - 环境变量可覆盖：BMSSP_K、BMSSP_T（覆盖 Sigma/Tau），BMSSP_STATS（输出 pulls/batches/inserts），BMSSP_STRICT（严格失败时非零退出）。
- 输出摘要：
  - 第一行：n, outdeg, Sigma, Tau, seed
  - 第二行：BMSSP_time, Dijkstra_time, time_ratio
  - 校验：verify 与 status（OK/FAIL）；若 FAIL，会打印 MISSMATCH 若干行。

## 脚本用法
- 基准采集：
  - 默认变体：lemma33 与 baseline；可用 -v 指定。
  - 预设规模：-m small|medium|large|all；或用 -n/-d/-s 定制。
  - 输出：CSV 文件，路径通过 -o 指定。
- 绘图：
  - 输入 CSV（与 benchmark.sh 兼容），输出到 --out 目录；生成比值、时间与（若有）操作计数曲线，以及一份 ratio 中位数汇总表。

## 常见问题
- 统计列全为 0：默认配置可能未触发队列重入路径，可增大规模或调整图结构；或按需要禁用回退（若保留该开关）。
- 校验 FAIL：先查看 MISSMATCH 行与 completeLog（pivot），排查 ell=1 的 BaseCase 是否写回正确、边松弛分派是否正确。

## 参考
- 论文 Algorithm 1~3 与 Lemma 3.3 的复杂度与接口含义。
- 代码中的中文行注释与本导读文档互为补充。
